<!DOCTYPE html>
<html >

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Lendary</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/fontawesome5-overrides.min.css">
    <link rel="stylesheet" href="assets/css/Navigation-Clean.css">
    <link rel="stylesheet" href="assets/css/Navigation-with-Search.css">
</head>

<body id="page-top" onload="checkLogin()">

    <div id="wrapper">
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                    <div class="container-fluid"><button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button"><i class="fas fa-bars"></i></button><img style="background: url(https://cdn.bootstrapstudio.io/placeholders/1400x800.png&quot;);width: 69px;" src="assets/img/facebook_profile_image.png">
                        <nav class="navbar navbar-light navbar-expand-md navigation-clean-search" style="width: 528.5px;height: 71px;">
                            <div class="container"><a class="navbar-brand" href="https://topicus.nl/">Topicus</a><a class="btn btn-primary" role="button" style="width: 140.4px;margin: 0px;padding: 7px 12px;" onclick="checkLogin()">History</a><a class="btn btn-primary" role="button" style="width: 140.4px;" onclick = "addLastAnalysis()" >Analytics</a>
                                <div class="btn-group" role="group"></div><button class="navbar-toggler" data-bs-toggle="collapse"><span class="visually-hidden">Toggle navigation</span><span class="navbar-toggler-icon"></span></button>
                            </div>
                        </nav>
                        <form class="d-none d-sm-inline-block me-auto ms-md-3 my-2 my-md-0 mw-100 navbar-search" style="padding: 0 0 0 40%">
                            <div class="input-group"> <a class="btn btn-primary" role="button" style="width: 90.4px;margin: 0px;padding: 7px 12px;" onclick="logout()">Logout</a></div>
                        </form>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown d-sm-none no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"><i class="fas fa-search"></i></a>
                                <div class="dropdown-menu dropdown-menu-end p-3 animated--grow-in" aria-labelledby="searchDropdown">
                                    <form class="me-auto navbar-search w-100">
                                        <div class="input-group"><input class="bg-light form-control border-0 small" type="text" placeholder="Search for ...">
                                            <div class="input-group-append"><button class="btn btn-primary py-0" type="button"><i class="fas fa-search"></i></button></div>
                                        </div>
                                    </form>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
                <div class="container-fluid">
                    <div class="card shadow">
                        <div class="card-header py-3">

                            <form id = "formm" action="./upload" target = "_blank"  method="POST" enctype="multipart/form-data">
                                <input id = "filee" class="btn btn-primary active" onchange="FileCheck()" type="file" name="file" style="margin: 0px;padding: 7px 26px;border-width: 1px;transform: rotate(0deg)";/>
                                <input class="btn btn-primary active text-center d-inline-block" type="submit" id ="but_submit" onclick="delay()" onload="delay()" style="margin-right: 0px;margin-left: 21px;width: 106.6px";/>
                            </form>

<!--                            <button class="btn btn-primary active" type="submit" style="margin: 0px;padding: 7px 26px;border-width: 1px;transform: rotate(0deg);">  <input type="file"  action="upload" method="post" enctype="multipart/form-data" name="file"/> </button><button class="btn btn-primary active text-center d-inline-block" type="submit" onclick="myFunction()" style="margin-right: 0px;margin-left: 21px;width: 106.6px;"> <input type="submit"/>.</button> <select style="margin-left: 117px;width: 398.4px;">-->

                            </select></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 text-nowrap">
                                    <!--  <div id="dataTable_length" class="dataTables_length" aria-controls="dataTable"><label class="form-label">Show&nbsp;<select class="d-inline-block form-select form-select-sm">
                                                <option value="10" selected="">10</option>
                                                <option value="25">25</option>
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                            </select>&nbsp;</label></div>-->
                                </div> 
                                <div class="col-md-6">
                                    <div class="text-md-end dataTables_filter" id="dataTable_filter"><label class="form-label"><input id="search1" onkeyup="search()" type="search" class="form-control form-control-sm" aria-controls="dataTable" placeholder="Search"></label> &nbsp &nbsp &nbsp &nbsp &nbsp</div>
                                </div>
                            </div>
                            <div class="table-responsive table mt-2" id="dataTable" role="grid" aria-describedby="dataTable_info">
                                <table class="table my-0" id="dataTable2">
                                    <thead>
                                    <tr>
                                        <th>Account id</th>
                                        <th>initial amount</th>
                                        <th>initial Date</th>
                                        <th>final amount</th>
                                        <th>final Date</th>
                                    </tr>
                                    </thead>
                                    <tbody id = "tcont">
                                    <tr>
                                        <td>--</td>
                                        <td>--</td>
                                        <td>--</td>
                                        <td>--</td>
                                        <td>--</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright Â© Brand 2021</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/chart.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/theme.js"></script>
    <script>
    	var LastAcc;
    	var hist =  window.location + "";
        link = (hist).slice(0,hist.lastIndexOf("/"));
        function myFunction(){

            var txt = "";
            var myObj;
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    myObj = JSON.parse(this.responseText);
                    var count = 0;
                    for(x in myObj){
                        acc = myObj[x].accountID;
                        if(count == 0){
                        	LastAcc = acc;
                        	if(LastAcc == "SQLError"){
                            	alert("Couldn't connect to the dataBase\n Please check your connection!");
                            	return;
                            }
                        	count++;
                        }
                        if(!acc.toLowerCase().includes(document.getElementById("search1").value.toLowerCase())){
                        	continue;
                        }
                        txt +=  "<tr>"
                            + "<td>" + myObj[x].accountID + "</td>"
                            + "<td>" + myObj[x].first_balance.amount + " " +  myObj[x].first_balance.currency + "</td>"
                            + "<td>" + myObj[x].statement_date + "</td>"
                            + "<td>" + myObj[x].final_balance.amount + " " +  myObj[x].final_balance.currency +"</td>"
                            + "<td>" + myObj[x].closing_date + "</td>"
                            + "<td><a class='btn btn-primary' role='button' onclick = 'addToAnalysis(\""+ acc +"\")' style='width: 90.4px;' >Analyse</a></td>"
                            + "<td><a class='btn btn-primary' role='button' onclick = 'remove(\""+ acc +"\")' style='width: 90.4px;'>Remove</a></td>"
                            + "</tr>";
                    }
                }
                document.getElementById("tcont").innerHTML = txt;
            };
            xhr.open('GET', link + '/rest/files', true);
            xhr.send();
            return;
        };

        function delay(){
            setTimeout(() => {  myFunction(); }, 1000);
        }

        function addToAnalysis(account){
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200){
                }
            }
            xmlhttp.open("POST", link + '/rest/analytics', true);
            xmlhttp.setRequestHeader("Content-type", "application/json");
            xmlhttp.send(JSON.stringify(account));

            location.assign("table.html");
        };
        
        function addLastAnalysis(){
        		addToAnalysis(LastAcc);
        		location.assign("table.html");
        }

        function FileCheck(){
        	var files = document.getElementById('filee').files;
        	var file = files[0];
        	var parts = file.name.split('.');
        	if(!parts[parts.length - 1].includes("940") || files.length == 0){
        		document.getElementById('filee').files[0] = null;
        		alert("File is not mt940 type!");
        		document.getElementById("formm").innerHTML = document.getElementById("formm").innerHTML;
        	}
        }
        
        
        function remove(id){
        	var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200){
                }
            }
            xmlhttp.open("DELETE", link + '/rest/files/remove', true);
            xmlhttp.setRequestHeader("Content-type", "application/json");
            xmlhttp.send(JSON.stringify(id));
            delay();
            myFunction();
        }
        function search(){
        	myFunction();
        }
        function checkLogin(){
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200){
                    myObj = this.responseText;
                    if (myObj == "false"){
                        location.assign(link);
                    }
                    else{
                        myFunction();
                    }
                }
            }
            xmlhttp.open("GET", link + '/rest/users', true);
            xmlhttp.send();

        }

        function logout(){
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200){
                }
            }
            xmlhttp.open("PUT", link + '/rest/users', true);
            xmlhttp.send();
            location.assign(link);
        }

        
        
    </script>
</body>

</html>